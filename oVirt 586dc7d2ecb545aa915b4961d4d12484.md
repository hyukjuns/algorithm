# oVirt

oVirt란 Host와 Guest 시스템을 중앙에서 관리하는 오픈소스 가상화 플랫폼, 오픈소스 분산 가상화 솔루션, 기업 인프라 관리 목적으로 디자인됨, KVM 하이퍼바이저를 사용하며, 몇몇 커뮤니티 프로젝트를 기반으로 구성됨

> oVirt 아키텍쳐

![oVirt%20586dc7d2ecb545aa915b4961d4d12484/Untitled.png](oVirt%20586dc7d2ecb545aa915b4961d4d12484/Untitled.png)

- Directory Server
- PostgreSQL
- Manger(Ovirt-Engine)

    물리적 자원과 가상의 자원을 중앙에서 관리하기 위한 플랫폼

    웹 서비스로 실행되는 JBoss기반 Java App ⇒  RHV, oVirt는 wildfly기반

    기업형 리눅스 위에 설치

- Host
    - 하나 이상의 가상 시스템을 실행하는 물리적인 서버
    - KVM을 사용해 완전 가상화 제공
    - 클러스터로 그룹화, 클러스터 그룹 내 마이그레이션 가능
    - AMD-v 또는 VT-x 하드웨어 가상화 확장 기능을 지원하는 CPU 필요, 최소 2GB RAM 필요
    - VDSM(Virtual Desktop Server Manager)

        엔진의 agent로 제공되는 관리 모듈, 엔진과 호스트 간의 통신 목적

        VDSM은 libvirtd를 사용하여 가상 머신을 시작, 중지, 재부팅 등의 명령을 전송한다

        *) 엔진에서  host를 연결할때 생성된다

        ![oVirt%20586dc7d2ecb545aa915b4961d4d12484/Untitled%201.png](oVirt%20586dc7d2ecb545aa915b4961d4d12484/Untitled%201.png)

- Storage
    - 디스크 이미지, 템플릿 및 ISO파일에 대한 접근 제공
    - 다양한 파일시스템 및 블록장치 접근 방식 지원(NAS or SAN)
- 데이터 웨어하우스
    - 보고 목적의 정보 기록, 엔진 설치 시 함께 설치 및 구성
- 네트워크
    - oVirt 환경 구성을 위한 필수 조건
    - ovrirtmgmt 논리 네트워크 기본 생성 ⇒ oVirt와 호스트 간의 관리 용도

> oVIrt Resources

- ovirt 구성 개략도

    Cluster : VM을 만들수 있는 Pool, 마이그레이션의 범위, Storage와 같은 Level

    ![oVirt%20586dc7d2ecb545aa915b4961d4d12484/Untitled%202.png](oVirt%20586dc7d2ecb545aa915b4961d4d12484/Untitled%202.png)

- Datacenter
- Cluster
- Host(or Node)
- Storage Domain
    - Data Domain (우선 순위, spm을 지정하고,spm이 기록해야하기때문, 스토리지 도메인의 조건중 하나, 다른 스토리지 도메인의 메타데이터를 가지고 있다) : vm의 disk들을 저장하는 목적
    - ISO Domain : disk에 들어갈 이미지 파일(.iso)을 저장하는 목적
    - Exports Domain : 백업 목적으로 vm의 disk파일을 압축한 .ova 파일을 저장하고, 배포할 목적
- Virtual Machine
- Pool

> **KVM**

- KVM의 장점은 파워 관리, Host들의 전원을 관리하여 불필요한 전력낭비를 막을 수 있고, 마이그레이션 시 선택된 호스트의 전원을 관리한다.
- Thin Hypervisor / Thick Hypervisor
    - Thin : type 1, 각 vm들에게 맥스 할당량을 할당하지만, 평균적인 사용량을 토대로 나머지 리소스를 재분배 할수 있다.
    - Thick : type 2, 일정한 할당량 만큼만 vm에게 제공하고 나머지 자원을 활용하기 힘듬, 성능은 좋음
- KSM(Kernel Same-page Merging)
    - KVM의 메모리 관리 기법, Host시스템에서 Guest OS 가 동일하면 메모리의 페이지를 공유
    - 메모리 페이지 공유 ⇒ 메모리 오버커밋
    - 오버헤드 또는 페이지 폴트 발생 의 원인이 됨
- VirtIO
    - 반가상화 I/O 장치를 Guest에게 부여, 벤더마다 이 반가상화된 장치에 대한 인터페이스는 다름

*) **ovirt 중첩 가상화 네트워크 개념**

- vm template
- live 마이그레이션 실패 방지 방법

    ⇒ 엔진의 고가용성 구축

    ⇒ self hosted engine or HA engine

    ⇒ 호스트가 다운되었을때 를 위한 vm 고가용성 구축 ⇒ vm도 같이 다운

    ⇒ 동일한 기능을 가진 vm을 다른 호스트에서 바로 띄움

***) VM Template 개념**

---

---

---

- RBAC

    ⇒ USER ↔ ROLE(Perm1, perm2, perm3 ...)

- oVirt 사용자 추가 방법

    ```bash
    [root@engine ~]# ovirt-aaa-jdbc-tool user add user01
    [root@engine ~]# ovirt-aaa-jdbc-tool user password-reset user01

    이후
    engine에서 admin으로 로그인
    => user01에 userrole 추가

    이후
    user01로 로그인 가능
    ```

- oVirt 논리네트워크 생성 방법

    논리네트워크는 역할을 할당받고 실제 노드의 물리네트워크에 할당되어 사용된다

    하나의 클러스터에 모든 호스트들이 공통으로 사용할 수 있다

    실제 노드에 있는 물리 NIC 와 oVirt에서 만든 논리 네트워크를 1대1 매치시켜 사용한다

    default로 생성되는 ovirtmgmt도 같은 방식

    1. Network tab - new - 논리네트워크 생성
    2. Cluster tab - 논리네트워크 - 네트워크 관리 - 새로생성한 논리네트워크에 역할 할당
    - 3. Host tab - node1 - Network Interface - 호스트 네트워크 설정

        위에서 생성한 논리네트워크는 할당되지 않은 상태로 있고, 호스트의 인터페이스에 논리네트워크를 할당 하면 된다.

        ![oVirt%20586dc7d2ecb545aa915b4961d4d12484/Untitled%203.png](oVirt%20586dc7d2ecb545aa915b4961d4d12484/Untitled%203.png)

실습환경

OS : 

![oVirt%20586dc7d2ecb545aa915b4961d4d12484/Untitled%204.png](oVirt%20586dc7d2ecb545aa915b4961d4d12484/Untitled%204.png)

virt-manager - qemu/kvm

![oVirt%20586dc7d2ecb545aa915b4961d4d12484/Untitled%205.png](oVirt%20586dc7d2ecb545aa915b4961d4d12484/Untitled%205.png)

ovirt-engine : ovirt_qcow2 (centos7)

uname: Linux [engine.cccr3.co.kr](http://engine.cccr3.co.kr/) 3.10.0-1127.13.1.el7.x86_64 #1 SMP Tue Jun 23 15:46:38 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux

ovirt-node : ovirt-node-ng-installer-4.3.9-2020031917.el7.iso

uname : Linux [node1.cccr3.co.kr](http://node1.cccr3.co.kr/) 3.10.0-1062.18.1.el7.x86_64 #1 SMP Tue Mar 17 23:49:17 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux

>>구성도 그림 제작

- 실습

    [OVIRT_TEST_ARCHI.drawio](oVirt%20586dc7d2ecb545aa915b4961d4d12484/OVIRT_TEST_ARCHI.drawio)

    KVM의 POWER관리 매니저 구성 X, (클러스터 내의 HOST들의 전원 관리 담당)

    실습  개략도

    ![oVirt%20586dc7d2ecb545aa915b4961d4d12484/Untitled%206.png](oVirt%20586dc7d2ecb545aa915b4961d4d12484/Untitled%206.png)

    - **사전 구성**
        - IP SETTING & Storage Setting

        - SETUP ENGINE

            ```
            1. Add the repo
            # yum install -y https://resources.ovirt.org/pub/yum-repo/ovirt-release43.rpm

            2. Update yum package
            # yum -y update

            3. Install the ovirt engine
            # yum -y install ovirt-engine

            4. ovirt-engine
            # engine-setup
            ```

        - ovirtmgmt network ⇒ Host와 그 안에 vm 들을 같은 네트워크 대역을 사용하게 함 ⇒ 브리지 네트워크 사용

            ![oVirt%20586dc7d2ecb545aa915b4961d4d12484/Untitled%207.png](oVirt%20586dc7d2ecb545aa915b4961d4d12484/Untitled%207.png)

        - 데이터센터 활성화 조건
            1. cluster 생성
            2. host 생성
            3. data storage 생성 
    - Trouble shooting
        1. 웹에서 엔진 안들어가질때

            ```
            <ENGINE>
            # vi /etc/ovirt-engine/engine.conf.d/99-custom-sso-setup.conf
            SSO_ALTERNATE_ENGINE_FQDNS="<호스트네임>.cccr3.co.kr"

            # systemctl restart ovirt-engine
            ```

    **실습 순서**

    1. ovirt 엔진 설치
    2. node(host)(bare-metal)생성
    3. storage(centos 7) 생성

        ⇒ nfs 서버 구성

        1. data 스토리지, iso 스토리지 export 등록
        2. chown -R 36:36 등록
    4. 웹(엔진) Cockpit 작업
        1. 데이터센터 생성
        2. 클러스터 생성
        3. 호스트 생성
            1. engine 과 node 연결 → 호스트에 vdsm 설치되는 과정

                ⇒ node에 ovritmgmt bridge 생성됨

        4. storage 도메인 생성

             ⇒ engine에서 node와 storage 연결

            1. data domain (우선적으로 생성해야 함, SPM)
            2. iso domain
        5. engine에서  iso domain으로 iso파일 업로드

            (iso파일은 engine shell에서 curl방식으로 iso 파일 다운받음

            curl -o centos7.8.iso [http://mirror.navercorp.com/centos/7.8.2003/isos/x86_64/CentOS-7-x86_64-Minimal-2003.iso](http://mirror.navercorp.com/centos/7.8.2003/isos/x86_64/CentOS-7-x86_64-Minimal-2003.iso))

            ⇒ ovirt-iso-uploader -i iso upload centos7.8.iso

        6. 가상머신 생성
            1. run - once run 클릭
            2. iso domain의 iso 파일 연결
                - 스크린샷

                    ![oVirt%20586dc7d2ecb545aa915b4961d4d12484/Untitled%208.png](oVirt%20586dc7d2ecb545aa915b4961d4d12484/Untitled%208.png)

- 실습2 마이그레이션 + wordpress
    - 사전 구성

        ```
        Engine(+Storage)
        - cpu: 2
        - Mem: 8192
        - Disk
          - vda: 30G
          - vdb: 20G => data
          - vdc: 5G => iso   (Centos7 iso file)
        - NIC:
          - eth0

        node1
        - cpu: 1
        - Mem: 3072
        - Disk:
          - vda: 20G
              /boot 1G
              swap  1G
              /var  10G
              /     나머지
        - NIC:
          - eth0
          - eth1 (Migration)

        node2
        - cpu: 1
        - Mem: 3072
        - Disk:
          - vda: 20G
              /boot 1G
              swap  1G
              /var  10G
              /     나머지
        - NIC:
          - eth0
          - eth1 (Migration)
        ```

    - Trouble shooting
        1. 스토리지 도메인 추가 error
            - Engine(+server) 에 스토리지 도메인 연결 실패 오류

                ⇒ 마운트포인트 /exports/data먼저 추가한 후 /exports/iso 를 스토리지 도메인 추가 실패오류

                ⇒ /exports/iso가 빈 폴더여야 하는데 data 도메인 연결할때 어떤 폴더가 같이 생겨버림

                ⇒ /exports/iso 폴더안에 있는것 다 지워주면 iso도메인추가 가능

    - 마이그레이션 네트워크 생성 192.168.123.0/24

        ![oVirt%20586dc7d2ecb545aa915b4961d4d12484/Untitled%209.png](oVirt%20586dc7d2ecb545aa915b4961d4d12484/Untitled%209.png)

    - + 웹서버 구성 후 migration result

        마이그레이션 전

        ![oVirt%20586dc7d2ecb545aa915b4961d4d12484/Untitled%2010.png](oVirt%20586dc7d2ecb545aa915b4961d4d12484/Untitled%2010.png)

        마이그레이션 후

        ![oVirt%20586dc7d2ecb545aa915b4961d4d12484/Untitled%2011.png](oVirt%20586dc7d2ecb545aa915b4961d4d12484/Untitled%2011.png)

        wordpress site 유지

        ![oVirt%20586dc7d2ecb545aa915b4961d4d12484/Untitled%2012.png](oVirt%20586dc7d2ecb545aa915b4961d4d12484/Untitled%2012.png)